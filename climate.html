<!DOCTYPE html>
<html>
    <head>
        <title>Impact of Climate Changes in Australia</title>

        <!--Load custom css-->
        <link rel="stylesheet" href="climate.css">
        <!--Load bootstrap-->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
              integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <script src="https://kit.fontawesome.com/5b075a4271.js" crossorigin="anonymous"></script>
    </head>

    <body>

        <!--Load d3js-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-cloud/1.2.5/d3.layout.cloud.min.js"></script>
        <!--Load jQuery-->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <!--        <script src="d3v4.js"></script>-->

        <div class="sidenav">
            <a href="#first"><i class="fas fa-globe-asia"></i> Introduction</a>
            <a href="#second"><i class="fas fa-water"></i> Catchment</a>
            <a href="#third"><i class="fas fa-temperature-high"></i> Temperature</a>
            <a href="#fourth"><i class="fas fa-sun"></i> Heatwave</a>
            <a href="#fifth"><i class="fas fa-burn"></i> Drought</a>
            <a href="#sixth"><i class="fas fa-flag-checkered"></i> End</a>
        </div>

        <div class="main" id="first">
            <h1 style="font-size: 3.5rem;font-weight: bolder; color: cadetblue">Climate Change: Is It an Out-Dated Topic?</h1>
            <p>Climate change is a word that everyone should be familiar with, <br><span style="font-weight: bolder"> but how much do people really know about climate change?</span></p>

            <p>Following is a Word Cloud generated from <a href="https://blog.gdeltproject.org/a-new-part-of-speech-dataset-to-explore-climate-change-narratives-in-english-online-news-2016-2020/">a speech dataset</a> that<br> contains recent English news that talked about climate change.</p>

            <div class="cloud"></div>

            <p><span style="font-weight: bolder">Greenhouse</span>, <span style="font-weight: bolder">Emissions</span>, <span style="font-weight: bolder">Carbon</span>... <br>That's what people are talking about when it comes to Climate Change<br>But how close is it?</p>

        </div>

        <div class="main" id="second">
            <h1 style="font-size: 3.5rem;font-weight: bolder; color: cadetblue">Climate Change is Closer Than You Think</h1>
            <p>What you might not know is, abnormal weather such as droughts<br> are having serious affect on the <a href="https://www.melbournewater.com.au/water/water-storage-and-use#/ws/freq/daily/type/storage%E3%80%81">water storage level</a> of Melbourne</p>

            <div class="row">
                <div class="col-lg-6 col-md-6">
                    <h2>History Water Storage Level of Melbourne</h2>
                    <p style="font-size: 25px; padding: 0rem">(Hover to see the percentage of water level)</p>
                    <div id="chart"></div>
                </div>

                <div class="col-lg-6 col-md-6">
                    <p style="padding-top: 2rem"><span style="font-weight: bolder; color: cornflowerblue">Over 80%</span> of Melbourne's water supply comes from water catchment: creeks, rivers, lakes, which is extremely vulnerable to droughts.
                        In 2000s, Australia has experienced the worst drought in history, which is also know as <a href="https://en.wikipedia.org/wiki/2000s_Australian_drought">The Millennium Drought</a>.
                        <br>With <a href="https://www.melbournewater.com.au/water/water-storage-and-use#/ws/freq/weekly/type/storage">history water storage data of the past decade</a>, we can easily identify the unusual drop of water storage in Melbourne in 2000s.<span style="font-style: italic; color: brown">
                        <br>Even though the storage level reach its peak at 2014, it has been dropping ever since.</span></p>
                </div>
            </div>

        </div>

        <div class="main" id="third">
            <h1 style="font-size: 3.5rem;font-weight: bolder; color: cadetblue">Australia is Getting Warmer</h1>
            <p>Temperature is one of the major measurements of climate change.<br>As an Australian resident, can you feel the heat?</p>

            <div class="row">
                <div class="col-lg-6 col-md-6">
                    <h2>The Increasing Temperature from 1912 to 2019</h2>
                    <p style="font-size: 25px; padding: 0rem">(Hover to see the mean highest temperature in each year)</p>
                    <div id="city-chart"></div>
                </div>

                <div class="col-lg-6 col-md-6">
                    <p style="padding-top: 2rem">According to NASA, <span style="font-weight: bolder; color: crimson">2 degrees Celsius</span> warming means <span style="font-weight: bolder; color: crimson">37 percent</span> of Earth's population will be exposed to severe heatwaves at least once every five years. <br>Since 1912, the <span>mean highest temperature</span> has increased <span style="font-weight: bolder; color: crimson">over 2 degrees</span> in <span style="color: #1f77b4">Canberra</span>, <span style="color: #ff7f0e">Sydney</span>, and <span style="color: #2ca02c"> Melbourne</span> despite they are experiencing different climate as inland city and coastal city.</p> 

                </div>
            </div>
        </div>

        <div class="main" id="fourth">
            <h1 style="font-size: 3.5rem;font-weight: bolder; color: cadetblue">More Heat Wave is Coming...</h1>
            <p>The median of mean highest temperature in Melbourne since 1912 is <span style="font-weight: bolder; color: crimson">19.5°C</span>.<br>If we considered any temperature over it as "hot", then the number of "hot years" in each decade is significantly increasing.</p>

            <div class="row">
                <div class="col-lg-6 col-md-6">
                    <h2>Increasing Number of "Hot Years"</h2>
                    <!--<p style="font-size: 25px; padding: 0rem">(Hover to see the mean highest temperature in each year)</p>-->
                    <div id="histogram"></div>
                </div>

                <div class="col-lg-6 col-md-6">
                    <p style="padding-top: 2rem">Starting from 1910s, it's not usual to experience a mean highest temperature over <span style="font-weight: bolder; color: crimson">19.5°C</span>, however, in the past two decades, we have went through the hottest <span style="font-weight: bolder; color: crimson">20 years</span> in the history </p> 
 
                </div>
            </div>
        </div>


        <div class="main" id="fifth">
            <h1 style="font-size: 3.5rem;font-weight: bolder; color: cadetblue">More Frequent Droughts</h1>
            <p>Less rainfall is the major cause of droughts. Using <a href="http://www.bom.gov.au/jsp/ncc/cdio/weatherData/av?p_nccObsCode=139&p_display_type=dataFile&p_startYear=&p_c=&p_stn_num=066006">the history rainfall data</a>, <br>the number of years that experienced a rainfall that was below average can be identified and compared.</p>

            <div class="row">
                <div class="col-lg-6 col-md-6">
                    <h2>The Number of "Drought Year" in Each 2 Decades</h2>
                    <p style="font-size: 25px; padding: 0rem">(Click to switch between cities)</p>
                    <div id="cities">

                        <button type="button" id="melbourne">Melbourne</button>
                        <button type="button" id="canberra">Canberra</button>
                        <button type="button" id="sydney">Sydney</button>
                    </div>

                    <p id="BubbleChart">
                        <script>
                            // Set the Attributes of the Graph
                            var diameter = 560,
                                format = d3.format(",d"),
                                color1 = d3.scale.category20c();

                            var pack = d3.layout.pack()
                            .size([diameter, diameter])
                            .padding(1.5);

                            //Create SVG element
                            var svg1 = d3.select("#BubbleChart").append("svg")
                            .attr("width", diameter)
                            .attr("height", diameter)
                            .attr("class", "bubble");


                            changebubble(0);



                            function changebubble(i) {
                                d3.csv("count_s.csv", function(csvData) {
                                    var years = ["Melbourne", "Canberra", "Sydney"];
                                    pack.value(function(d) {
                                        return +d["count" + years[i]];
                                    });

                                    var data = {
                                        name: "city",
                                        children: csvData
                                    };

                                    var node = svg1.selectAll("g.node")
                                    .data(pack.nodes(data), function(d) {
                                        return d.period;
                                    });

                                    var nodeEnter = node.enter().append("g")
                                    .attr("class", "node")
                                    .attr("transform", function(d) {
                                        return "translate(" + d.x + "," + d.y + ")";
                                    });

                                    //Add the Circles
                                    var circles = nodeEnter.append("circle")
                                    .attr("r", function(d) {
                                        return d.r;
                                    })
                                    .style("fill", function(d) {
                                        return color1(d.period);
                                    });

                                    nodeEnter.append("title")
                                        .text(function(d) {
                                        return d.period + " : " + format(d.value);
                                    });

                                    //Add the Texts
                                    nodeEnter.append("text")
                                        .attr("dy", ".2em")
                                        .style("text-anchor", "middle")
                                        .text(function(d) {
                                        return d.period
                                    });

                                    nodeEnter.append("text")
                                        .attr("class", "value")
                                        .attr("dy", "1.3em")
                                        .style("text-anchor", "middle")
                                        .text(function(d) {
                                        return d.value
                                    });


                                    node.select("circle")
                                        .transition().duration(1000)
                                        .attr("r", function(d) {
                                        return d.r;
                                    })
                                        .style("fill", function(d) {
                                        return color1(d.period);
                                    });

                                    node.transition().duration(1000).attr("class", "node")
                                        .attr("transform", function(d) {
                                        return "translate(" + d.x + "," + d.y + ")";
                                    });

                                    node.select(".value")
                                        .text(function(d) {
                                        return format(d.value);
                                    });

                                    node.select("title")
                                        .text(function(d) {
                                        return d.period + " : " + format(d.value);
                                    });

                                    node.on('mouseover', highlightThisOne);
                                    node.on('mouseout', restoreAllColors);

                                    function highlightThisOne(d) {
                                        console.log(d);
                                        d3.selectAll("g.node").transition().duration(500)
                                            .attr("fill", function(d) {
                                            return color1(d.period);
                                        });
                                        d3.select(this).transition().duration(500)
                                            .attr('fill', "orange");
                                    }

                                    function restoreAllColors(d) {
                                        d3.selectAll("g.node").transition().duration(500)
                                            .attr("font-weight", "bold")
                                            .attr("fill", "black");
                                    }

                                    node.exit().remove();


                                });
                            }

                            function updateBubble1() {
                                changebubble(0);
                            }

                            function updateBubble2() {
                                changebubble(1);
                            }

                            function updateBubble3() {
                                changebubble(2);
                            }


                            d3.select("#melbourne").on("click", updateBubble1);
                            d3.select("#canberra").on("click", updateBubble2);
                            d3.select("#sydney").on("click", updateBubble3);
                        </script>
                    </p>

                </div>

                <div class="col-lg-6 col-md-6">
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">Time Period</th>
                                <th scope="col">Melbourne</th>
                                <th scope="col">Canberra</th>
                                <th scope="col">Sydney</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th scope="row">1920-1939</th>
                                <td>13</td>
                                <td>14</td>
                                <td>14</td>
                            </tr>
                            <tr>
                                <th scope="row">1940-1959</th>
                                <td>5</td>
                                <td>11</td>
                                <td>10</td>
                            </tr>
                            <tr>
                                <th scope="row">1960-1979</th>
                                <td>9</td>
                                <td>8</td>
                                <td>2</td>
                            </tr>                            <tr>
                            <th scope="row">1980-1999</th>
                            <td>10</td>
                            <td>9</td>
                            <td>18</td>
                            </tr>
                            <tr>
                                <th scope="row">2000-2019</th>
                                <td>16</td>
                                <td>13</td>
                                <td>16</td>
                            </tr>

                        </tbody>
                    </table>

                    <p style="padding-top: 2rem">It's easy to find out that Melbourne, Canberra, and Sydney is getting less and less rain since 1960s. What's worth mentioning is: in 1920s, Australia experienced one of the worst droughts, which lead to <a href="https://knowledge.aidr.org.au/resources/environment-national-drought-1918/">the water restriction in Sydney</a>. </p> 

                </div>
            </div>
        </div>


        <div class="main" id="sixth">
            <h1 style="font-size: 5.5rem;font-weight: bolder; color: cadetblue; padding-top: 30rem;">Now, How Close Do You Think Climate Change Is?</h1>

        </div>











        <!--Word Cloud-->
        <script>
            var climateText = "";

            d3.csv("WebPos.csv", function(data) {
                for (var i = 0; i < data.length; i++) {
                    climateText = climateText + " " + data[i].token;
                }

                text2 = climateText,

                    words = sortByFrequency( text2.split(/[ ,.]+/) )
                    .map(function(d,i) {
                    //console.log(d);
                    return {text: d, size: -i};
                });

                var fontName = "Impact",
                    cWidth = 900,
                    cHeight = 600,
                    svg,
                    wCloud,
                    bbox,
                    ctm,
                    bScale,
                    bWidth,
                    bHeight,
                    bMidX,
                    bMidY,
                    bDeltaX,
                    bDeltaY;

                var cTemp = document.createElement('canvas'),
                    ctx = cTemp.getContext('2d');
                ctx.font = "100px " + fontName;

                var fRatio = Math.min(cWidth, cHeight) / ctx.measureText(words[0].text).width,
                    fontScale = d3.scale.linear()
                .domain([
                    d3.min(words, function(d) { return d.size; }), 
                    d3.max(words, function(d) { return d.size; })
                ])
                //.range([20,120]),
                .range([20,100*fRatio/2]), // tbc
                    fill = d3.scale.category20();

                d3.layout.cloud()
                    .size([cWidth, cHeight])
                    .words(words)
                //.padding(2) // controls
                    .rotate(function() { return ~~(Math.random() * 2) * 90; })
                    .font(fontName)
                    .fontSize(function(d) { return fontScale(d.size) })
                    .on("end", draw)
                    .start();

                function draw(words, bounds) {
                    // move and scale cloud bounds to canvas
                    // bounds = [{x0, y0}, {x1, y1}]
                    bWidth = bounds[1].x - bounds[0].x;
                    bHeight = bounds[1].y - bounds[0].y;
                    bMidX = bounds[0].x + bWidth/2;
                    bMidY = bounds[0].y + bHeight/2;
                    bDeltaX = cWidth/2 - bounds[0].x + bWidth/2;
                    bDeltaY = cHeight/2 - bounds[0].y + bHeight/2;
                    bScale = bounds ? Math.min( cWidth / bWidth, cHeight / bHeight) : 1;

                    console.log(
                        "bounds (" + bounds[0].x + 
                        ", " + bounds[0].y + 
                        ", " + bounds[1].x + 
                        ", " + bounds[1].y + 
                        "), width " + bWidth +
                        ", height " + bHeight +
                        ", mid (" + bMidX +
                        ", " + bMidY +
                        "), delta (" + bDeltaX +
                        ", " + bDeltaY +
                        "), scale " + bScale
                    );



                    svg = d3.select(".cloud").append("svg")
                        .attr("width", cWidth)
                        .attr("height", cHeight);

                    wCloud = svg.append("g")
                        .attr("transform", "translate(" + [bWidth>>1, bHeight>>1] + ") scale(" + bScale + ")") 
                        .selectAll("text")
                        .data(words)
                        .enter().append("text")
                        .style("font-size", function(d) { return d.size + "px"; })
                        .style("font-family", fontName)
                        .style("fill", function(d, i) { return fill(i); })
                        .attr("text-anchor", "middle")
                        .transition()
                        .duration(500)
                        .attr("transform", function(d) {
                        return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                    })
                        .text(function(d) { return d.text; });


                    bbox = wCloud.node(0).getBBox();

                    console.log(
                        "bbox (x: " + bbox.x + 
                        ", y: " + bbox.y + 
                        ", w: " + bbox.width + 
                        ", h: " + bbox.height + 
                        ")"
                    );

                };

                function sortByFrequency(arr) {
                    var f = {};
                    arr.forEach(function(i) { f[i] = 0; });
                    var u = arr.filter(function(i) { return ++f[i] == 1; });
                    return u.sort(function(a, b) { return f[b] - f[a]; });
                }
            });
        </script>

        <!--Water Storage Level Chart-->
        <script>


            d3.csv("history_water_storage_level.csv", function(data) {

                console.log(data);

                var years = [];
                var levels = [];

                for(var i = 0; i < data.length; i++) {

                    years.push(data[i].Year)
                    levels.push(data[i].Value)
                }

                console.log(years);
                console.log(levels);



                var myData = levels,
                    colors = ['#ACF0F2', '#1b6ca8' ],
                    width = 800,
                    height = 500,
                    padding = 60,
                    barWidth = 50,
                    outerPadding = .2,
                    barPadding = .1;


                console.log(myData);

                var scales = [73.2, 139.22, 205.24, 271.26, 337.28, 403.30, 469.32, 535.3, 601.3, 667.4];

                var colorScale = d3.scale.linear()
                .domain( [ 50, d3.max( myData ) ] )
                .range( colors );

                var xScale = d3.scale.ordinal()
                .domain( d3.range( 2010, 2020 ) )
                .rangeBands( [ padding, width - padding ], barPadding, outerPadding );

                var yScale = d3.scale.linear()
                .domain( [ d3.max( myData ), 0  ]  )
                .range( [ height - (padding * 2), 0 ] );

                var yAxisScale = d3.scale.linear()
                .domain( [ Math.round( d3.max( myData ) ), 0 ]  )
                .range( [ 0, height - ( padding * 2 ) ] );

                var xAxis = d3.svg.axis()
                .scale( xScale )
                .orient( 'bottom' );

                var yAxis = d3.svg.axis()
                .scale( yAxisScale )
                .orient( 'left' )
                .ticks( 7 );

                var chart = d3.select( '#chart' )
                .append( 'svg' )
                .attr( 'width', width )
                .attr( 'height', height );



                var chartBars = chart.selectAll( 'rect' ).data( myData )
                .enter().append( 'rect' )
                .attr( 'class', 'chart-bar' )
                .attr( 'width', function( d ) { return xScale.rangeBand(); })
                .attr( 'height', 0 )
                .attr( 'fill', colorScale )
                .attr( 'x', function( d, i ) { 
                    return scales[i]; })
                .attr( 'y', height  - padding );


                var labelSVG = chart.selectAll( 'svg' ).data( myData )
                .enter().append( 'svg' )
                .attr( 'class', 'chart-label-svg' )
                .attr( 'width', 80 )
                .attr( 'height', 30 )
                .attr( 'x', function( d, i ) { return scales[i] + xScale.rangeBand(); })
                .attr( 'y', function( d ){ return height - yScale( d ) - padding - 30;})
                .style( 'opacity', '0' )
                .append( 'g' )
                ;

                labelSVG.append( 'rect' )
                    .attr( 'class', 'chart-label-rect' )
                    .attr( 'width', 120 )
                    .attr( 'height', 30 )
                    .attr( 'x', 0 )
                    .attr( 'y', 0 )
                    .attr( 'fill', 'grey' );

                labelSVG.append( 'text' )
                    .attr( 'x', '50%' )
                    .attr( 'y', '50%' )
                    .attr( 'text-anchor', 'middle' )
                    .attr( 'alignment-baseline', 'middle' )
                    .attr( 'fill', 'white' )
                    .text( function( d ) { return d + "%"; });

                var xAxisG = chart.append( 'g' )
                .attr( 'class', 'axis' )
                .attr( 'transform', 'translate(0,' + (height - padding) + ')' )
                .call( xAxis );

                var yAxisG = chart.append( 'g' )
                .attr( 'class', 'axis' )
                .attr( 'transform', 'translate(' + padding + ', '+ padding +')' )
                .call( yAxis );

                var rectTransitions = chartBars
                .on('mouseenter', function( d, i ){
                    d3.select( this )
                        .style( 'fill', d3.rgb( colorScale( d ) ).brighter( .3 ) );
                    d3.selectAll( '.chart-label-svg' )
                        .filter(function( e, j ){
                        if  (i === j ) {
                            return this;
                        }
                    })
                        .style( 'opacity', '1.0' );
                })
                .on('mouseleave', function( d, i ){
                    d3.select( this )
                        .style( 'fill', d3.rgb( colorScale( d ) ) );
                    d3.selectAll( '.chart-label-svg' )
                        .filter(function( e, j ){
                        if ( i === j ) {
                            return this;
                        }
                    })
                        .style( 'opacity', '0' );
                })
                .transition()
                .duration( 1000 )
                .delay( function( d, i ) {return i * 15; })
                .ease( 'elastic' )
                .attr( 'height', function( d ) { return yScale( d ); })
                .attr( 'y', function(d) { return height - yScale(d) - padding; } );




            });
        </script>


        <!--Multi-line chart-->
        <script>

            d3.csv("climate.csv", function(data) {
                console.log(data);


                var marginCity = {
                    top: 20,
                    right: 80,
                    bottom: 30,
                    left: 50
                },
                    widthCity = 900 - marginCity.left - marginCity.right,
                    heightCity = 500 - marginCity.top - marginCity.bottom;

                var parseDate = d3.time.format("%Y").parse;

                var x = d3.time.scale()
                .range([0, widthCity]);

                var y = d3.scale.linear()
                .range([heightCity, 0]);

                var color = d3.scale.category10();

                var xAxis = d3.svg.axis()
                .scale(x)
                .orient("bottom");

                var yAxis = d3.svg.axis()
                .scale(y)
                .orient("left");

                var line = d3.svg.line()
                .interpolate("basis")
                .x(function(d) {
                    return x(d.date);
                })
                .y(function(d) {
                    return y(d.temperature);
                });

                var svg = d3.select("#city-chart").append("svg")
                .attr("width", widthCity + marginCity.left + marginCity.right)
                .attr("height", heightCity + marginCity.top + marginCity.bottom)
                .append("g")
                .attr("transform", "translate(" + marginCity.left + "," + marginCity.top + ")");


                console.log(data);

                color.domain(d3.keys(data[0]).filter(function(key) {
                    return key !== "date";
                }));

                data.forEach(function(d) {
                    d.date = parseDate(d.date);
                });

                var cities = color.domain().map(function(name) {
                    return {
                        name: name,
                        values: data.map(function(d) {
                            return {
                                date: d.date,
                                temperature: +d[name]
                            };
                        })
                    };
                });

                x.domain(d3.extent(data, function(d) {
                    return d.date;
                }));

                y.domain([
                    d3.min(cities, function(c) {
                        return d3.min(c.values, function(v) {
                            return v.temperature;
                        });
                    }),
                    d3.max(cities, function(c) {
                        return d3.max(c.values, function(v) {
                            return v.temperature;
                        });
                    })
                ]);

                var legend = svg.selectAll('g')
                .data(cities)
                .enter()
                .append('g')
                .attr('class', 'legend');

                legend.append('rect')
                    .attr('x', widthCity - 300)
                    .attr('y', function(d, i) {
                    return i * 20;
                })
                    .attr('width', 10)
                    .attr('height', 10)
                    .style('fill', function(d) {
                    return color(d.name);
                });

                legend.append('text')
                    .attr('x', widthCity - 270)
                    .attr('y', function(d, i) {
                    return (i * 20) + 9;
                })
                    .text(function(d) {
                    return d.name;
                });

                svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + heightCity + ")")
                    .call(xAxis);

                svg.append("g")
                    .attr("class", "y axis")
                    .call(yAxis)
                    .append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 6)
                    .attr("dy", ".71em")
                    .style("text-anchor", "end")
                    .text("Temperature (ºC)");

                var city = svg.selectAll(".city")
                .data(cities)
                .enter().append("g")
                .attr("class", "city");

                city.append("path")
                    .attr("class", "line")
                    .attr("d", function(d) {
                    return line(d.values);
                })
                    .style("stroke", function(d) {
                    return color(d.name);
                });

                city.append("text")
                    .datum(function(d) {
                    return {
                        name: d.name,
                        value: d.values[d.values.length - 1]
                    };
                })
                    .attr("transform", function(d) {
                    return "translate(" + x(d.value.date) + "," + y(d.value.temperature) + ")";
                })
                    .attr("x", 3)
                    .attr("dy", ".35em");

                var mouseG = svg.append("g")
                .attr("class", "mouse-over-effects");

                mouseG.append("path") // this is the black vertical line to follow mouse
                    .attr("class", "mouse-line")
                    .style("stroke", "black")
                    .style("stroke-width", "1px")
                    .style("opacity", "0");

                var lines = document.getElementsByClassName('line');

                var mousePerLine = mouseG.selectAll('.mouse-per-line')
                .data(cities)
                .enter()
                .append("g")
                .attr("class", "mouse-per-line");

                mousePerLine.append("circle")
                    .attr("r", 7)
                    .style("stroke", function(d) {
                    return color(d.name);
                })
                    .style("fill", "none")
                    .style("stroke-width", "1px")
                    .style("opacity", "0");

                mousePerLine.append("text")
                    .attr("transform", "translate(10,3)");

                mouseG.append('svg:rect') // append a rect to catch mouse movements on canvas
                    .attr('width', widthCity) // can't catch mouse events on a g element
                    .attr('height', heightCity)
                    .attr('fill', 'none')
                    .attr('pointer-events', 'all')
                    .on('mouseout', function() { // on mouse out hide line, circles and text
                    d3.select(".mouse-line")
                        .style("opacity", "0");
                    d3.selectAll(".mouse-per-line circle")
                        .style("opacity", "0");
                    d3.selectAll(".mouse-per-line text")
                        .style("opacity", "0");
                })
                    .on('mouseover', function() { // on mouse in show line, circles and text
                    d3.select(".mouse-line")
                        .style("opacity", "1");
                    d3.selectAll(".mouse-per-line circle")
                        .style("opacity", "1");
                    d3.selectAll(".mouse-per-line text")
                        .style("opacity", "1");
                })
                    .on('mousemove', function() { // mouse moving over canvas
                    var mouse = d3.mouse(this);
                    d3.select(".mouse-line")
                        .attr("d", function() {
                        var d = "M" + mouse[0] + "," + heightCity;
                        d += " " + mouse[0] + "," + 0;
                        return d;
                    });

                    d3.selectAll(".mouse-per-line")
                        .attr("transform", function(d, i) {
                        console.log(widthCity/mouse[0])
                        var xDate = x.invert(mouse[0]),
                            bisect = d3.bisector(function(d) { return d.date; }).right;
                        idx = bisect(d.values, xDate);

                        var beginning = 0,
                            end = lines[i].getTotalLength(),
                            target = null;

                        while (true){
                            target = Math.floor((beginning + end) / 2);
                            pos = lines[i].getPointAtLength(target);
                            if ((target === end || target === beginning) && pos.x !== mouse[0]) {
                                break;
                            }
                            if (pos.x > mouse[0])      end = target;
                            else if (pos.x < mouse[0]) beginning = target;
                            else break; //position found
                        }

                        d3.select(this).select('text')
                            .text(y.invert(pos.y).toFixed(2));

                        return "translate(" + mouse[0] + "," + pos.y +")";
                    });
                });
            });

        </script>



        <script>
            d3.csv("droughts.csv", function(data) {

                console.log(data);

                var years = [];
                var levels = [];

                for(var i = 0; i < data.length; i++) {

                    years.push(data[i].Year)
                    levels.push(data[i].Value)
                }

                console.log(years);
                console.log(levels);



                var myData = levels,
                    colors = ['#ff7670', '#ff0707' ],
                    width = 800,
                    height = 500,
                    padding = 60,
                    barWidth = 20,
                    outerPadding = .2,
                    barPadding = .1;


                console.log(myData);

                var scales = [70, 130.2, 190.2, 250, 310, 370, 430, 490, 550, 610, 670];

                var colorScale = d3.scale.linear()
                .domain( [ 50, d3.max( myData ) ] )
                .range( colors );

                var xScale = d3.scale.ordinal()
                .domain( d3.range( 1910, 2020,10 ) )
                .rangeBands( [ padding, width - padding ], barPadding, outerPadding );

                var yScale = d3.scale.linear()
                .domain( [ 10, 0  ]  )
                .range( [ height - (padding * 2), 0 ] );

                var yAxisScale = d3.scale.linear()
                .domain( [ 10, 0 ]  )
                .range( [ 0, height - ( padding * 2 ) ] );

                var xAxis = d3.svg.axis()
                .scale( xScale )
                .orient( 'bottom' );

                var yAxis = d3.svg.axis()
                .scale( yAxisScale )
                .orient( 'left' )
                .ticks( 7 );

                var chart = d3.select( '#histogram' )
                .append( 'svg' )
                .attr( 'width', width )
                .attr( 'height', height );



                var chartBars = chart.selectAll( 'rect' ).data( myData )
                .enter().append( 'rect' )
                .attr( 'class', 'chart-bar' )
                .attr( 'width', function( d ) { return xScale.rangeBand(); })
                .attr( 'height', 0 )
                .attr( 'fill', colorScale )
                .attr( 'x', function( d, i ) { 
                    return scales[i]; })
                .attr( 'y', height  - padding );



                var xAxisG = chart.append( 'g' )
                .attr( 'class', 'axis' )
                .attr( 'transform', 'translate(0,' + (height - padding) + ')' )
                .call( xAxis );

                var yAxisG = chart.append( 'g' )
                .attr( 'class', 'axis' )
                .attr( 'transform', 'translate(' + padding + ', '+ padding +')' )
                .call( yAxis );

                var rectTransitions = chartBars
                .on('mouseenter', function( d, i ){
                    d3.select( this )
                        .style( 'fill', d3.rgb( colorScale( d ) ).brighter( .3 ) );
                    d3.selectAll( '.chart-label-svg' )
                        .filter(function( e, j ){
                        if  (i === j ) {
                            return this;
                        }
                    })
                        .style( 'opacity', '1.0' );
                })
                .on('mouseleave', function( d, i ){
                    d3.select( this )
                        .style( 'fill', d3.rgb( colorScale( d ) ) );
                    d3.selectAll( '.chart-label-svg' )
                        .filter(function( e, j ){
                        if ( i === j ) {
                            return this;
                        }
                    })
                        .style( 'opacity', '0' );
                })
                .transition()
                .duration( 1000 )
                .delay( function( d, i ) {return i * 15; })
                .ease( 'elastic' )
                .attr( 'height', function( d ) { return yScale( d ); })
                .attr( 'y', function(d) { return height - yScale(d) - padding; } );




            });
        </script>




    </body>
</html>

